# 3D 非線形カルマンフィルタ性能比較シミュレーション (Rust)

## プログラムの概要

このRustプログラムは、**強い非線形性**を持つ移動体の3次元空間での位置を推定するためのシミュレーションです。様々な種類のカルマンフィルタを実装し、特に非線形な状況下における推定性能を視覚的に比較することを目的としています。

シミュレーションでは、真の軌道を**螺旋（らせん）運動**とし、観測モデルを**レーダーからの距離・方位角・仰角**とすることで、強い非線形性を持つ状況を再現します。これにより、単純な線形近似を行う拡張カルマンフィルタ(EKF)と、より高度な非線形フィルタ（UKF, CKFなど）との性能差を明確に評価できます。

-----

## 各フィルタの概要と数学的理論

### 状態空間モデル

* **状態ベクトル $x_k$ (フィルタ内部モデル)**: 各フィルタは、対象が等速直線運動(CV)していると仮定します。
    $`x_k = [p_x, p_y, p_z, v_x, v_y, v_z]^T`$

* **真の運動モデル**: 実際には、対象は以下の螺旋軌道を描きます。

    - $`p_x(t) = R \cos(\omega t)`$
    - $`p_y(t) = R \sin(\omega t)`$
    - $`p_z(t) = ct`$

    このため、フィルタの内部モデルと真の運動の間には常に**モデル化誤差**が存在します。

* **観測方程式 $`z_k = h(x_k) + v_k`$ (非線形)**: 観測は、原点`(0,0,0)`にあるセンサーから得られる距離(range)、方位角(azimuth)、仰角(elevation)です。

    $`z_k = \begin{bmatrix} r \\ \alpha \\ \epsilon \end{bmatrix} = h(x_k) + v_k = \begin{bmatrix} \sqrt{p_x^2 + p_y^2 + p_z^2} \\ \text{atan2}(p_y, p_x) \\ \text{atan2}(p_z, \sqrt{p_x^2 + p_y^2}) \end{bmatrix} + v_k`$

    この観測関数 $`h(\cdot)`$ は強い非線形性を持っています。

### 各フィルタの役割

1.  **拡張カルマンフィルタ (EKF: Extended Kalman Filter)**
    非線形観測関数 $`h(\cdot)`$ を**ヤコビ行列（偏微分による線形近似行列）** $`H_k`$ を用いて扱います。
    $`H_k = \frac{\partial h}{\partial x} \bigg|_{\hat{x}_{k|k-1}}`$
    ヤコビ行列の計算は複雑で、強い非線形性を持つ領域（特に原点付近）では近似誤差が大きくなり、推定性能が著しく劣化したり、発散したりする可能性があります。

2.  **アンセンテッドカルマンフィルタ (UKF: Unscented Kalman Filter)**
    ヤコビ行列を計算せず、**シグマポイント**と呼ばれる代表点を非線形関数 $`h(\cdot)`$ で直接変換し、その結果から統計量（平均と共分散）を再計算します。これにより、EKFよりも高次の項まで非線形性を捉えることができ、高い推定精度が期待されます。

3.  **キューバチャーカルマンフィルタ (CKF: Cubature Kalman Filter)**
    UKFと似たサンプリングベースの手法ですが、**キューバチャーポイント**と呼ばれる異なる点の選び方・重み付けをします。UKFと同様に、ヤコビ行列計算が不要で非線形性に強いです。

4.  **ロバストキューバチャーカルマンフィルタ (RCKF: Robust CKF)**
    CKFをベースに、外れ値（異常な観測値）への耐性を加えたものです。観測残差が一定の閾値を超えた場合に、観測ノイズの共分散を一時的に大きくすることで外れ値の影響を抑制します。

5.  **最大相関エントロピー平方根CKF (MCSRCKF: Maximum Correntropy Square-Root CKF)**
    CKFをベースに、**最大相関エントロピー基準(MCC)** を用いてロバスト性を実現したフィルタです。観測残差の大きさに応じて**ガウスカーネル**から重みを計算し、観測ノイズの共分散を「滑らかに」調整します。RCKFが閾値でON/OFF的に対応するのに対し、MCSRCKFは残差の大きさに応じて連続的に影響度を調整するため、より洗練された外れ値抑制が可能です。「平方根(Square-Root)」は、計算の安定性を確保するために共分散行列の平方根を扱うことに由来します。

6.  **対話型多重モデルフィルタ (IMM-UKF: Interacting Multiple Model Filter)**
    複数の運動モデル（ここでは「通常のCVモデル」と「機動モデル」）を並行して実行し、結果を確率的に統合します。螺旋運動のように常に運動パターンが変化する対象に対して、よりロバストな追従が期待されます。

-----

## 実行方法

1.  Rust環境と`ffmpeg`を準備します。
2.  `cargo run --release` を実行します。
3.  [cite_start]`frames`フォルダに連番画像が、ルートディレクトリに`nonlinear_comparison_large.mp4`が生成されます。
